<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta property="og:title" content="PDO中使用了ATTR_AUTOCOMMIT的一个坑" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://hoohack.me/blog/2015/2015-06-25-PDO-hole-ATTR-AUTOCOMMIT/" />
  <link rel="stylesheet" href="/styles/main.css">
  <link rel="me" href="https://mas.to/@djyde">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.27.0/themes/prism.min.css">
  
  <title>PDO中使用了ATTR_AUTOCOMMIT的一个坑 | Hoohack&#39;s Blog</title>
  
  <script async src="https://ana.hoohack.me/ana.js" data-website-id="380499a9-5e2b-4320-bb7d-fc6bb57fdf79"></script>
</head>
<body>
  
<div>
  <div class="container mx-auto prose py-12 sm:py-24 px-12 sm:px-0">
    <div class="mb-12">
      <a class="no-underline font-bold" href="/">Hoohack&#39;s Blog</a>
    </div>
    <h1>PDO中使用了ATTR_AUTOCOMMIT的一个坑</h1>
    <div class="italic text-gray-500">
      2015/06/25
    </div>
    <div>
      <p>很久没有写博客了，最近工作比较多，没有做到一星期至少一文章。在这里记录下开发过程中在PDO里遇到的一个坑。</p>
<p>有一次，在执行数据库的INSERT操作时，返回的插入结果是新增的插入行的ID，但是在数据库里面没有看到插入的记录。查找了数据库的Log发现也没有执行sql的记录。折腾了恒久，然后在配置文件将所有配置去掉之后发现执行成功了。后来逐项配置取消，最后发现是设置了<code>PDO::ATTR_AUTOCOMMIT =&gt; 0</code>这个选项。于是便上网查找相关原因如下。</p>
<p>在配置PDO时，设置了一项<code>PDO::ATTR_AUTOCOMMIT =&gt; 0</code>。阅读PHP手册发现，如果这项设为false，那么PDO将试图禁用自动提交以便数据库连接开始一个事务。然而，通过阅读MYSQL文档发现这么一段话：</p>
<blockquote>
<p>After disabling autocommit mode by setting the autocommit variable to zero, changes to transaction-safe tables (such as those for InnoDB or NDBCLUSTER) are not made permanent immediately. You must use COMMIT to store your changes to disk or ROLLBACK to ignore the changes.</p>
</blockquote>
<p>意思是当你设置了autocommit为0时，就会将事务安全的表(如InnoDB或NDBCLUSTER)将会变成非马上提交的。你必须使用COMMIT来保存你的改变到硬盘中或者ROLLBACK来回滚事务。</p>
<p>而UPDATE/INSERT操作会在下面两中情况下被锁住：</p>
<blockquote>
<ul>
<li>在一个事务中</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>不在事务中而且set autocommit = 0被启用了</li>
</ul>
</blockquote>
<p>所以我使用了ATTR_AUTOCOMMIT来允许PDO对象启用一个事务，我没有在程序里面使用事务语句，但PDO默认认为我使用了事务。这意味着，不管你没有使用事务的查询语句中是否使用了自动提交，PDO都会默认的开启事务，以后所有的SQL都将做为事务处理，直到你用commit确认或rollback结束。因为没有提交事务，所以PDO就没有将需要执行的SQL语句提交到MySQL中，但还是会返回成功插入后的ID，因此数据库里面没有记录。</p>
<p>网上对这个做法的观点不一，但我认为各有各的说法，在实现过程中，只在需要使用事务的时候才使用这个选项，而不是在全局配置中设置就好了。</p>

    </div>
    <hr />
      <div class="text-sm text-center">
        <div id="tcomment"></div>
<script src="https://cdn.staticfile.org/twikoo/1.6.16/twikoo.all.min.js"></script>
<script>
twikoo.init({
  envId: 'https://discus.hoohack.me', // 腾讯云环境填 envId；Vercel 环境填地址（https://xxx.vercel.app）
  el: '#tcomment', // 容器元素
  // region: 'ap-guangzhou', // 环境地域，默认为 ap-shanghai，腾讯云环境填 ap-shanghai 或 ap-guangzhou；Vercel 环境不填
  // path: location.pathname, // 用于区分不同文章的自定义 js 路径，如果您的文章路径不是 location.pathname，需传此参数
  // lang: 'zh-CN', // 用于手动设定评论区语言，支持的语言列表 https://github.com/imaegoo/twikoo/blob/main/src/client/utils/i18n/index.js
})
</script>
      </div>
      <hr />
    <div class="text-center">
<img class="w-64 inline-block" src="https://www.hoohack.me/assets/images/reward.jpeg" alt="" />
<div class="text-sm">
通过赞赏码赞助此文
</div>
</div>
    <footer class="text-sm py-12 text-gray-500 text-center">
  Hoohack's Blog since 2014
</footer>
  </div>

</div>



</body>
</html>