<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta property="og:title" content="使用拦截器统一处理异常" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://hoohack.me/blog/2020/2020-06-13-handle-exception-in-one-place/" />
  <link rel="stylesheet" href="/styles/main.css">
  <link rel="me" href="https://mas.to/@djyde">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.27.0/themes/prism.min.css">
  
  <title>使用拦截器统一处理异常 | Hoohack&#39;s Blog</title>
  
  <script async src="https://ana.hoohack.me/ana.js" data-website-id="380499a9-5e2b-4320-bb7d-fc6bb57fdf79"></script>
</head>
<body>
  
<div>
  <div class="container mx-auto prose py-12 sm:py-24 px-12 sm:px-0">
    <div class="mb-12">
      <a class="no-underline font-bold" href="/">Hoohack&#39;s Blog</a>
    </div>
    <h1>使用拦截器统一处理异常</h1>
    <div class="italic text-gray-500">
      2020/06/13
    </div>
    <div>
      <p>作为一个业务仔，在业务接口代码中肯定会遇到处理异常的情况，比如有代码逻辑的异常，业务逻辑的异常等等。这些异常场景是非常非常多的，这么多异常逻辑要处理，就意味着要写很多重复的代码，作为一个有点追求的业务仔，不能只是懂得CURD，当然希望代码看起来简洁、舒服一点。</p>
<p>本文打算分享笔者处理异常情况的演进过程，然后给出统一异常处理的示例。</p>
<p>一开始的方法是定义一个业务异常类，当捕获到业务异常时，使用异常的错误码和错误信息，构造错误提示返回。</p>
<pre class="language-java"><code class="language-java"><span class="token comment">/**<br>* 错误码枚举类<br>*/</span><br><span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">ResponseCode</span> <span class="token punctuation">{</span><br>    <span class="token function">SUCCESS</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"OK"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>    <span class="token function">SERVER_ERROR</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"server error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">private</span> <span class="token keyword">int</span> code<span class="token punctuation">;</span><br>    <span class="token keyword">private</span> <span class="token class-name">String</span> msg<span class="token punctuation">;</span><br><br>    <span class="token class-name">ResponseCode</span><span class="token punctuation">(</span><span class="token keyword">int</span> code<span class="token punctuation">,</span> <span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">this</span><span class="token punctuation">.</span>code <span class="token operator">=</span> code<span class="token punctuation">;</span><br>        <span class="token keyword">this</span><span class="token punctuation">.</span>msg <span class="token operator">=</span> msg<span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> code<span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">public</span> <span class="token class-name">ResponseCode</span> <span class="token function">setCode</span><span class="token punctuation">(</span><span class="token keyword">int</span> code<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">this</span><span class="token punctuation">.</span>code <span class="token operator">=</span> code<span class="token punctuation">;</span><br>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> msg<span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">public</span> <span class="token class-name">ResponseCode</span> <span class="token function">setMsg</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">this</span><span class="token punctuation">.</span>msg <span class="token operator">=</span> msg<span class="token punctuation">;</span><br>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token comment">/**<br>* 自定义业务异常类<br>*/</span><br><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BizException</span> <span class="token keyword">extends</span> <span class="token class-name">RuntimeException</span> <span class="token punctuation">{</span><br><br>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> code<span class="token punctuation">;</span><br><br>    <span class="token keyword">public</span> <span class="token class-name">BizException</span><span class="token punctuation">(</span><span class="token class-name">ResponseCode</span> errCode<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">super</span><span class="token punctuation">(</span>errCode<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">this</span><span class="token punctuation">.</span>code <span class="token operator">=</span> errCode<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">public</span> <span class="token class-name">BizException</span><span class="token punctuation">(</span><span class="token class-name">ResponseCode</span> errCode<span class="token punctuation">,</span> <span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">super</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">this</span><span class="token punctuation">.</span>code <span class="token operator">=</span> errCode<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">public</span> <span class="token class-name">BizException</span><span class="token punctuation">(</span><span class="token keyword">int</span> code<span class="token punctuation">,</span> <span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">super</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">this</span><span class="token punctuation">.</span>code <span class="token operator">=</span> code<span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>code<span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br><span class="token punctuation">}</span><br><br><span class="token keyword">class</span> <span class="token class-name">TestService</span> <span class="token punctuation">{</span><br>	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testAMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		<span class="token comment">// 业务异常代码</span><br>		<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BizException</span><span class="token punctuation">(</span><span class="token class-name">ResponseCode</span><span class="token punctuation">.</span><span class="token constant">BIZ_CODE</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>	<span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token comment">/**<br>* 接口返回的通用结构HttpResult<br>* {"code": 0, "msg": "OK"}<br>*/</span><br><span class="token keyword">class</span> <span class="token class-name">TestController</span> <span class="token punctuation">{</span><br><br>	<span class="token annotation punctuation">@Autowired</span><br>	<span class="token keyword">private</span> <span class="token class-name">TestService</span> testService<span class="token punctuation">;</span><br><br>	<span class="token keyword">public</span> <span class="token class-name">HttpResult</span> <span class="token function">testA</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		<span class="token keyword">try</span> <span class="token punctuation">{</span><br>			testService<span class="token punctuation">.</span><span class="token function">testAMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BizException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>			<span class="token keyword">return</span> <span class="token class-name">HttpResult</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>			<span class="token keyword">return</span> <span class="token class-name">HttpResult</span><span class="token punctuation">(</span><span class="token class-name">ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SERVER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>		<span class="token punctuation">}</span><br><br>		<span class="token keyword">return</span> <span class="token class-name">HttpResult</span><span class="token punctuation">(</span><span class="token class-name">ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>	<span class="token punctuation">}</span><br><br><span class="token punctuation">}</span><br></code></pre>
<p>后来发现需要进行一次优化，首先，随着业务代码越来越多，这些try...catch看起来就好臃肿了。</p>
<p>其次，在底层代码有异常时也要在外层捕获住，然后一层一层地往外抛，直到业务接口返回处返回错误信息，如果是一个业务逻辑特别复杂的接口，这些异常处理的代码就会遍布整个系统，使得这些异常代码看起来十分不美观，代码可读性也较差。</p>
<p>久而久之，就在想是否有一种跟<a href="https://www.hoohack.me/2020/04/22/common-check-with-interceptor">校验拦截器</a>一样的方法，在某个地方统一处理这些判断，使得代码看起来比较美观。<strong>答案是有的</strong>，就是使用<code>ExceptionHandler</code>和<code>RestControllerAdvice</code>注解。</p>
<p>首先，定义一个类：<code>SpringMvcExceptionDemo</code>，类加上<code>RestControllerAdvice</code>注解，类里面定义一个方法exceptionHandler，方法前面加上<code>ExceptionHandler</code>注解，然后就可以在方法里面写异常判断逻辑，对异常逻辑进行相应的处理。</p>
<p>具体的实现代码示例如下：</p>
<pre class="language-java"><code class="language-java"><br><span class="token annotation punctuation">@RestControllerAdvice</span><br><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpringMvcExceptionDemo</span> <span class="token punctuation">{</span><br><br>    <span class="token annotation punctuation">@ExceptionHandler</span><br>    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">exceptionHandler</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">BizException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token class-name">BizException</span> be <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">BizException</span><span class="token punctuation">)</span> e<span class="token punctuation">;</span><br>            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">HttpResult</span><span class="token punctuation">(</span>be<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> be<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">HttpResult</span><span class="token punctuation">(</span><span class="token class-name">ResponseCode</span><span class="token punctuation">.</span><span class="token constant">PARAM_ERROR</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br><br>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">HttpResult</span><span class="token punctuation">(</span><span class="token class-name">ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SERVER_ERR</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br><span class="token punctuation">}</span><br><br><span class="token keyword">public</span> <span class="token class-name">HttpResult</span> <span class="token function">testA</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	testService<span class="token punctuation">.</span><span class="token function">testAMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>	<span class="token keyword">return</span> <span class="token class-name">HttpResult</span><span class="token punctuation">(</span><span class="token class-name">ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br></code></pre>
<p>这样一来，就只需要在该抛出业务异常的地方抛出异常，由拦截器统一处理异常即可，减少了很多重复代码，同时提高代码的可读性。</p>
<p>RestControllerAdvice 和 ExceptionHandler</p>
<blockquote>
<p>RestControllerAdvice是Spring框架中的一个注解，这个注解包含了<code>ControllerAdvice</code>和<code>ResponseBody</code>，帮助我们通过加入一个横切点<code>ExceptionHandler</code>来处理RestfulAPI中的异常。执行的时机是在<code>doDispatch</code>中，调用<code>processDispatchResult</code>方法，如果有异常，则会调用添加了<code>ExceptionHandler</code>注解的方法去判断。</p>
</blockquote>
<p>流程图如下：</p>
<p><img src="https://www.hoohack.me/assets/images/2020/06/exception-handler-progress.jpg" alt="统一处理异常拦截器流程"></p>
<p>核心处理代码：</p>
<pre class="language-java"><code class="language-java"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">HandlerExceptionResolver</span> handlerExceptionResolver <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handlerExceptionResolvers<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	exMv <span class="token operator">=</span> handlerExceptionResolver<span class="token punctuation">.</span><span class="token function">resolveException</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span><br>	<span class="token keyword">if</span> <span class="token punctuation">(</span>exMv <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		<span class="token keyword">break</span><span class="token punctuation">;</span><br>	<span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<h2 id="%E6%80%BB%E7%BB%93" tabindex="-1">总结</h2>
<p>代码和原理比较简单，统一处理异常的目的只是为了消除重复的代码块，写出更简洁的代码，现在写代码也是坚持这个想法，希望能探索出更多的技巧，有其他技巧的也欢迎一起讨论。</p>
<p>原创文章，文笔有限，才疏学浅，文中若有不正之处，万望告知。</p>

    </div>
    <hr />
      <div class="text-sm text-center">
        评论和交流请发送邮件到 hoohackhu@gmail.com
      </div>
      <hr />
    <div class="text-center">
<img class="w-64 inline-block" src="https://www.hoohack.me/assets/images/reward.jpeg" alt="" />
<div class="text-sm">
通过赞赏码赞助此文
</div>
</div>
    <footer class="text-sm py-12 text-gray-500 text-center">
  Hoohack's Blog since 2014
</footer>
  </div>

</div>



</body>
</html>