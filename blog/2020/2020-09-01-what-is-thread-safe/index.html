<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta property="og:title" content="你真的知道什么是线程安全吗？" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://hoohack.me/blog/2020/2020-09-01-what-is-thread-safe/" />
  <link rel="stylesheet" href="/styles/main.css">
  <link rel="me" href="https://mas.to/@djyde">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.27.0/themes/prism.min.css">
  
  <title>你真的知道什么是线程安全吗？ | Hoohack&#39;s Blog</title>
  
  <script async src="https://ana.hoohack.me/ana.js" data-website-id="380499a9-5e2b-4320-bb7d-fc6bb57fdf79"></script>
</head>
<body>
  
<div>
  <div class="container mx-auto prose py-12 sm:py-24 px-12 sm:px-0">
    <div class="mb-12">
      <a class="no-underline font-bold" href="/">Hoohack&#39;s Blog</a>
    </div>
    <h1>你真的知道什么是线程安全吗？</h1>
    <div class="italic text-gray-500">
      2020/09/01
    </div>
    <div>
      <p>如果面试官问你，线程安全的类有哪些，究竟什么是线程安全？你怎么回答呢？我们整天说线程安全，但你真的知道什么是线程安全吗？</p>
<h2 id="%E4%BB%80%E4%B9%88%E6%98%AF%E8%BF%9B%E7%A8%8B" tabindex="-1">什么是进程</h2>
<p>从学术上理解，进程就是<code>包含上下文切换的程序执行时间总和 = CPU加载上下文+CPU执行+CPU保存上下文</code>。</p>
<p>另一个简单的理解，进程就是程序的一次执行，比如看看一下这个图，每一个运行中的程序就是一个独立的进程，进程是相互独立存在的。</p>
<p><img src="https://www.hoohack.me/assets/images/2020/09/mac-monitor.jpg" alt=""></p>
<h2 id="%E4%BB%80%E4%B9%88%E6%98%AF%E7%BA%BF%E7%A8%8B" tabindex="-1">什么是线程</h2>
<p>线程就是CPU执行那一部分的一个个小段，线程是CPU的基本调度单位。</p>
<blockquote>
<p>注：平时大家说“因为Redis是单线程的，所以它是原子性的”，根本原因是，因为线程是CPU的最小调度单元，CPU每次只能执行成功或者失败才调度切换到下一个线程，所以Redis的操作都是原子的。</p>
</blockquote>
<p>进程和线程都是一个时间段的描述，是CPU工作时间段的描述，不过是颗粒大小不同。</p>
<h2 id="%E5%A0%86%E5%92%8C%E6%A0%88" tabindex="-1">堆和栈</h2>
<p>进程与线程中比较重要的内存区域有堆和栈。</p>
<p><strong>堆</strong>是进程和线程共有的空间，分全局堆和局部堆。全局堆就是所有没有分配的空间，局部堆就是用户分配的空间。堆在操作系统对进程初始化的时候分配，运行过程中也可以向系统要额外的堆，但是用完了要还给操作系统，要不然就是内存泄漏。</p>
<blockquote>
<p>在Java中，堆是Java虚拟机所管理的内存中最大的一块，是所有线程共享的一块内存区域，在虚拟机启动时创建。堆所存在的内存区域的唯一目的就是存放对象实例，几乎所有的对象实例以及数组都在这里分配内存。</p>
</blockquote>
<p><strong>栈</strong>是每个线程独有的，保存其运行状态和局部自动变量的。栈在线程开始的时候初始化，每个线程的栈互相独立，因此，栈是线程安全的。操作系统在切换线程的时候会自动切换栈。栈空间不需要在高级语言里面显式的分配和释放。</p>
<h2 id="%E8%BF%9B%E7%A8%8B%E5%92%8C%E7%BA%BF%E7%A8%8B%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE" tabindex="-1">进程和线程中的数据</h2>
<p>程序几乎都需要与数据打交道，读取数据（命令行参数，文件），写入数据（设置变量，写入文件）。这些数据是保存在进程所管理的内存里。</p>
<p>为了保证数据的安全，比如一个进程中修改的数据不会影响到另一个进程的数据，每一个进程都会拥有操作系统分配给自己的内存空间，而不能访问其他进程的数据，这一点是由操作系统保证的。</p>
<p>进程占有的资源：地址空间，全局变量，打开的文件，子进程，信号量，账户信息</p>
<p>线程占有的资源：栈，寄存器，状态，程序计数器</p>
<p>进程是操作系统进行资源分配和调度的一个独立单位，不会共享资源，通过进程间通信共享资源，而线程可以共享部分资源，独自占有的资源不共享。</p>
<p>线程间共享的数据包括：</p>
<ul>
<li>1、堆</li>
<li>2、进程代码段</li>
<li>3、进程的公有数据</li>
</ul>
<p>对于线程间共享的内存区域，如果进程中的A线程操作了数据，切换到B线程执行，修改了同样的数据，回到A线程时，数据就不是A线程切换时候的样子，这样一来，数据就被污染了，我们就说这块数据在多线程环境下是不安全的，即线程不安全的。</p>
<p>这就是线程安全这个概念产生的背景，笔者认为，谈论线程安全性，一定需要先介绍操作系统中进程与线程操作内存的过程，否则，说一个对象是安全的还是不安全的就显得有点突兀，而且相对于什么是安全的也不知道。</p>
<h2 id="%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E6%80%A7" tabindex="-1">线程安全性</h2>
<p>《Java并发编程实战》给出的定义如下：
一个对象是否需要是线程安全的，取决于它是否被多个线程访问。这只和对象在程序中是以何种方式被使用的有关，和对象本身具体是做什么的无关。</p>
<p>当多个线程访问某个类时，这个类始终都能表现出正确的行为，那么就称这个类是线程安全的。</p>
<p>线程安全的程序不一定是由线程安全的类组成，完全由线程安全类组成的程序也不一定是线程安全的。还需要一定的组合技巧才能保证线程安全。</p>
<p>要编写线程安全的代码，其核心在于要对对象状态访问操作进行管理，特别是对共享的（Shared）和可变的（Mutable）状态的访问，即数据的访问，而数据是存储在内存中，也就是说，线程安全的本质不是代码在线程中的安全，而是线程中内存的安全。</p>
<p>至此，线程安全的概念介绍完毕，<strong>最后的最后，你知道有哪些方法可以保证线程安全吗？</strong></p>
<h2 id="%E6%80%BB%E7%BB%93" tabindex="-1">总结</h2>
<p>分享一个学习方法，带着问题去看书。有时候看一本书，从头到尾看完确实非常枯燥无味，且很容易就放弃了，最近想到一个方法就是带着问题去看，比如《Java并发编程实战》，据说是Java并发编程的神书，但是很枯燥，而且中文版也难懂，看了好多次之后没能进入状态，后来就想着，能不能去网上看看一些面试题，看看这本书究竟能给我解答什么疑惑，怀着这样的心情，就把前三章看完了。</p>
<p>带着问题去看，目的性较强，更容易去理解，再通过自己的语言描述出来，印象就更深刻了。</p>
<p>原创文章，文笔有限，才疏学浅，文中若有不正之处，万望告知。</p>

    </div>
    <hr />
      <div class="text-sm text-center">
        <div id="tcomment"></div>
<script src="https://cdn.staticfile.org/twikoo/1.6.16/twikoo.all.min.js"></script>
<script>
twikoo.init({
  envId: 'https://discus.hoohack.me', // 腾讯云环境填 envId；Vercel 环境填地址（https://xxx.vercel.app）
  el: '#tcomment', // 容器元素
  // region: 'ap-guangzhou', // 环境地域，默认为 ap-shanghai，腾讯云环境填 ap-shanghai 或 ap-guangzhou；Vercel 环境不填
  // path: location.pathname, // 用于区分不同文章的自定义 js 路径，如果您的文章路径不是 location.pathname，需传此参数
  // lang: 'zh-CN', // 用于手动设定评论区语言，支持的语言列表 https://github.com/imaegoo/twikoo/blob/main/src/client/utils/i18n/index.js
})
</script>
      </div>
      <hr />
    <div class="text-center">
<img class="w-64 inline-block" src="https://www.hoohack.me/assets/images/reward.jpeg" alt="" />
<div class="text-sm">
通过赞赏码赞助此文
</div>
</div>
    <footer class="text-sm py-12 text-gray-500 text-center">
  Hoohack's Blog since 2014
</footer>
  </div>

</div>



</body>
</html>