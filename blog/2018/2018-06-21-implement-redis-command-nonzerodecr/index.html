<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta property="og:title" content="［Redis源码阅读］实现一个redis命令--nonzerodecr" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://hoohack.me/blog/2018/2018-06-21-implement-redis-command-nonzerodecr/" />
  <link rel="stylesheet" href="/styles/main.css">
  <link rel="me" href="https://mas.to/@djyde">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.27.0/themes/prism.min.css">
  
  <title>［Redis源码阅读］实现一个redis命令--nonzerodecr | Hoohack&#39;s Blog</title>
  
  <script async src="https://ana.hoohack.me/ana.js" data-website-id="380499a9-5e2b-4320-bb7d-fc6bb57fdf79"></script>
</head>
<body>
  
<div>
  <div class="container mx-auto prose py-12 sm:py-24 px-12 sm:px-0">
    <div class="mb-12">
      <a class="no-underline font-bold" href="/">Hoohack&#39;s Blog</a>
    </div>
    <h1>［Redis源码阅读］实现一个redis命令--nonzerodecr</h1>
    <div class="italic text-gray-500">
      2018/06/21
    </div>
    <div>
      <p><a href="http://u6.gg/dCVQx">上篇文章</a>介绍了命令的执行流程，对redis如何执行命令也有了初步的了解，通过实现一个redis命令来再次加深印象。</p>
<p>笔者平时主要语言是PHP，有些功能PHP无法满足就会用到PHP的扩展，比如swoole。因此，就想到redis可不可以以做扩展？为了满足一些特殊的需求，可不可以为redis开发一个命令？</p>
<h2 id="%E5%89%8D%E6%9C%9F%E5%87%86%E5%A4%87" tabindex="-1">前期准备</h2>
<p>因为redis是用C开发的，为了能开发redis命令，首先也是必须的是，你要懂一点C语言基础，另一个就是，需要了解一下redis命令是如何执行的，知道redis执行命令大概的流程，最简单的一个流程描述就是：</p>
<p>读取命令-&gt;解析命令-&gt;调用命令函数-&gt;返回执行结果</p>
<p>或者再读一次<a href="http://u6.gg/dCVQx">上篇文章</a>。</p>
<p>我们要做的就是，确保redis能解析到新增的命令，能根据输入的命令找到对应的方法并执行。</p>
<h2 id="%E5%87%BD%E6%95%B0%E9%9C%80%E6%B1%82" tabindex="-1">函数需求</h2>
<p>要实现一个命令，说明当前redis的命令无法满足开发的需求。考虑这样的一个需求，在秒杀的情景下，达到了这样的case：商品剩下最后一件，两个用户同时抢购，使用业务代码：</p>
<pre class="language-c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span>redis<span class="token operator">-></span><span class="token function">decr</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> success<br><span class="token punctuation">}</span></code></pre>
<p>这样做有个问题就是活动结束后，key的值可能为-1，这样对于最终查询库存时会出现负值，不利于数据对账及统计。那么，能不能新增一个命令，让redis在计算时判断key的值，如果是0就不进行扣减呢？</p>
<p>将函数命名为nonzerodecr，开始实现。</p>
<h2 id="%E6%B7%BB%E5%8A%A0%E5%87%BD%E6%95%B0%E5%90%8D%E5%88%B0%E5%91%BD%E4%BB%A4%E8%A1%A8" tabindex="-1">添加函数名到命令表</h2>
<p>把函数名称添加到命令表，参照decr命令的命令表：</p>
<pre class="language-c"><code class="language-c"><span class="token punctuation">{</span><span class="token string">"decr"</span><span class="token punctuation">,</span>decrCommand<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">"wmF"</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">}</span></code></pre>
<p>增加nonzerodecrCommand：</p>
<pre class="language-c"><code class="language-c"><span class="token punctuation">{</span><span class="token string">"nonzerodecr"</span><span class="token punctuation">,</span>nonzerodecrCommand<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">"wmF"</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span></code></pre>
<p>声明nonzerodecr，因为新增的命令nonzerodecr只是内部增加一个非0的判断，其余操作没有变化，因此只需要跟decrCommand一样的声明即可：</p>
<pre class="language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">nonzerodecrCommand</span><span class="token punctuation">(</span>client <span class="token operator">*</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h2 id="%E5%AE%9E%E7%8E%B0%E5%87%BD%E6%95%B0" tabindex="-1">实现函数</h2>
<p>在实现新的函数之前，先看看decrComamnd命令的实现：</p>
<pre class="language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">decrCommand</span><span class="token punctuation">(</span>client <span class="token operator">*</span>c<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token function">incrDecrCommand</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<p>函数调用了incrDecrCommand实现自增和自减，实现如下：</p>
<pre class="language-c"><code class="language-c"><span class="token comment">/*<br>* incr、decr具体的实现<br>*/</span><br><br><span class="token keyword">void</span> <span class="token function">incrDecrCommand</span><span class="token punctuation">(</span>client <span class="token operator">*</span>c<span class="token punctuation">,</span> <span class="token keyword">long</span> <span class="token keyword">long</span> incr<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">long</span> <span class="token keyword">long</span> value<span class="token punctuation">,</span> oldvalue<span class="token punctuation">;</span><br>  robj <span class="token operator">*</span>o<span class="token punctuation">,</span> <span class="token operator">*</span>new<span class="token punctuation">;</span><br><br>  <span class="token comment">// 检查key和value的类型</span><br>  o <span class="token operator">=</span> <span class="token function">lookupKeyWrite</span><span class="token punctuation">(</span>c<span class="token operator">-></span>db<span class="token punctuation">,</span>c<span class="token operator">-></span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>o <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> <span class="token function">checkType</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span>o<span class="token punctuation">,</span>OBJ_STRING<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getLongLongFromObjectOrReply</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span>o<span class="token punctuation">,</span><span class="token operator">&amp;</span>value<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">!=</span> C_OK<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// 处理执行后溢出的情况</span><br>  oldvalue <span class="token operator">=</span> value<span class="token punctuation">;</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>incr <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> oldvalue <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> incr <span class="token operator">&lt;</span> <span class="token punctuation">(</span>LLONG_MIN<span class="token operator">-</span>oldvalue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span><br>      <span class="token punctuation">(</span>incr <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> oldvalue <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> incr <span class="token operator">></span> <span class="token punctuation">(</span>LLONG_MAX<span class="token operator">-</span>oldvalue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token function">addReplyError</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span><span class="token string">"increment or decrement would overflow"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token keyword">return</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  value <span class="token operator">+=</span> incr<span class="token punctuation">;</span><br>  <span class="token comment">/*<br>  * 在long范围内，直接赋值，否则使用longlong创建字符串后再赋值<br>  */</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>o <span class="token operator">&amp;&amp;</span> o<span class="token operator">-></span>refcount <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> o<span class="token operator">-></span>encoding <span class="token operator">==</span> OBJ_ENCODING_INT <span class="token operator">&amp;&amp;</span><br>    <span class="token punctuation">(</span>value <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> value <span class="token operator">>=</span> OBJ_SHARED_INTEGERS<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span><br>    value <span class="token operator">>=</span> LONG_MIN <span class="token operator">&amp;&amp;</span> value <span class="token operator">&lt;=</span> LONG_MAX<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    new <span class="token operator">=</span> o<span class="token punctuation">;</span><br>    o<span class="token operator">-></span>ptr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>    new <span class="token operator">=</span> <span class="token function">createStringObjectFromLongLong</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>o<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token function">dbOverwrite</span><span class="token punctuation">(</span>c<span class="token operator">-></span>db<span class="token punctuation">,</span>c<span class="token operator">-></span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>new<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>        <span class="token function">dbAdd</span><span class="token punctuation">(</span>c<span class="token operator">-></span>db<span class="token punctuation">,</span>c<span class="token operator">-></span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>new<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br>  <span class="token function">signalModifiedKey</span><span class="token punctuation">(</span>c<span class="token operator">-></span>db<span class="token punctuation">,</span>c<span class="token operator">-></span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token function">notifyKeyspaceEvent</span><span class="token punctuation">(</span>NOTIFY_STRING<span class="token punctuation">,</span><span class="token string">"incrby"</span><span class="token punctuation">,</span>c<span class="token operator">-></span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>c<span class="token operator">-></span>db<span class="token operator">-></span>id<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  server<span class="token punctuation">.</span>dirty<span class="token operator">++</span><span class="token punctuation">;</span><br>  <span class="token function">addReply</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span>shared<span class="token punctuation">.</span>colon<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token function">addReply</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span>new<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token function">addReply</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span>shared<span class="token punctuation">.</span>crlf<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br></code></pre>
<p>函数的流程图如下：</p>
<p><img src="https://www.hoohack.me/assets/images/2018/06/incrDecrCommand.png" alt="incrDecrCommand"></p>
<p>如图所示，要实现函数nonzerodecrCommand，只需要在进行增/减操作前增加一个大于等于0 的判断即可，其余的逻辑不变，实现如下：</p>
<pre class="language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">nonzerodecrCommand</span><span class="token punctuation">(</span>client <span class="token operator">*</span>c<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">long</span> <span class="token keyword">long</span> incr <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><br>    <span class="token keyword">long</span> <span class="token keyword">long</span> value<span class="token punctuation">,</span> oldvalue<span class="token punctuation">;</span><br>    robj <span class="token operator">*</span>o<span class="token punctuation">,</span> <span class="token operator">*</span>new<span class="token punctuation">;</span><br>    <span class="token comment">// 检查key和value的类型</span><br>    o <span class="token operator">=</span> <span class="token function">lookupKeyWrite</span><span class="token punctuation">(</span>c<span class="token operator">-></span>db<span class="token punctuation">,</span>c<span class="token operator">-></span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>o <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> <span class="token function">checkType</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span>o<span class="token punctuation">,</span>OBJ_STRING<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getLongLongFromObjectOrReply</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span>o<span class="token punctuation">,</span><span class="token operator">&amp;</span>value<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">!=</span> C_OK<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span><br>    <span class="token comment">// 处理执行后溢出的情况</span><br>    oldvalue <span class="token operator">=</span> value<span class="token punctuation">;</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>incr <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> oldvalue <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> incr <span class="token operator">&lt;</span> <span class="token punctuation">(</span>LLONG_MIN<span class="token operator">-</span>oldvalue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token function">addReplyError</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span><span class="token string">"increment or decrement would overflow"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">return</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>    value <span class="token operator">+=</span> incr<span class="token punctuation">;</span><br>    <span class="token comment">// 判断，如果操作后结果小于0，直接返回</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token function">addReply</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span>shared<span class="token punctuation">.</span>czero<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">return</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>    <br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>o <span class="token operator">&amp;&amp;</span> o<span class="token operator">-></span>refcount <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> o<span class="token operator">-></span>encoding <span class="token operator">==</span> OBJ_ENCODING_INT <span class="token operator">&amp;&amp;</span><br>      <span class="token punctuation">(</span>value <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> value <span class="token operator">>=</span> OBJ_SHARED_INTEGERS<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span><br>      value <span class="token operator">>=</span> LONG_MIN <span class="token operator">&amp;&amp;</span> value <span class="token operator">&lt;=</span> LONG_MAX<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      new <span class="token operator">=</span> o<span class="token punctuation">;</span><br>      o<span class="token operator">-></span>ptr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>      new <span class="token operator">=</span> <span class="token function">createStringObjectFromLongLong</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span>o<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>          <span class="token function">dbOverwrite</span><span class="token punctuation">(</span>c<span class="token operator">-></span>db<span class="token punctuation">,</span>c<span class="token operator">-></span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>new<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>          <span class="token function">dbAdd</span><span class="token punctuation">(</span>c<span class="token operator">-></span>db<span class="token punctuation">,</span>c<span class="token operator">-></span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>new<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br>    <span class="token function">signalModifiedKey</span><span class="token punctuation">(</span>c<span class="token operator">-></span>db<span class="token punctuation">,</span>c<span class="token operator">-></span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token function">notifyKeyspaceEvent</span><span class="token punctuation">(</span>NOTIFY_STRING<span class="token punctuation">,</span><span class="token string">"incrby"</span><span class="token punctuation">,</span>c<span class="token operator">-></span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>c<span class="token operator">-></span>db<span class="token operator">-></span>id<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    server<span class="token punctuation">.</span>dirty<span class="token operator">++</span><span class="token punctuation">;</span><br>    <span class="token function">addReply</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span>shared<span class="token punctuation">.</span>colon<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token function">addReply</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span>new<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token function">addReply</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span>shared<span class="token punctuation">.</span>crlf<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<h2 id="%E7%BC%96%E8%AF%91%E6%B5%8B%E8%AF%95" tabindex="-1">编译测试</h2>
<p>编写完代码后，对代码进行编译测试：</p>
<pre class="language-shell"><code class="language-shell"><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> <span class="token builtin class-name">set</span> totalCount <span class="token number">1</span><br>OK<br><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> get totalCount<br><span class="token string">"1"</span><br><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> nonzerodecr totalCount<br><span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">0</span><br><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> get totalCount<br><span class="token string">"0"</span><br><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> nonzerodecr totalCount<br><span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">0</span><br><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> get totalCount<br><span class="token string">"0"</span></code></pre>
<p>结果符合最初的需求，在值等于0之后，再进行扣减，值不会变为负数。</p>
<h2 id="%E6%80%BB%E7%BB%93%E4%B8%8E%E6%80%9D%E8%80%83" tabindex="-1">总结与思考</h2>
<p>通过介绍实现nonzerodecr命令的过程，对如何实现一个命令有了一个初步的认识，之后如果有新的需求也可以根据这个步骤去实现一个新的命令。</p>
<p>上面介绍的命令实现方式比较粗暴，可能会有隐藏的bug，但对于入门实现一个命令这个目的来说，这个代码时可以的，另外，一开始提到的秒杀场景除了可以使用新命令来解决，也可以使用redis-lua脚本的形式来实现，实现方法是多样的，具体的技术选型需要根据业务的场景来选择，如果你有更好的方案，欢迎评论留下你的方案。</p>
<p>原创文章，文笔有限，才疏学浅，文中若有不正之处，万望告知。</p>
<p>如果本文对你有帮助，请点个赞吧，谢谢^_^</p>

    </div>
    <hr />
      <div class="text-sm text-center">
        评论和交流请发送邮件到 hoohackhu@gmail.com
      </div>
      <hr />
    <div class="text-center">
<img class="w-64 inline-block" src="https://www.hoohack.me/assets/images/reward.jpeg" alt="" />
<div class="text-sm">
通过赞赏码赞助此文
</div>
</div>
    <footer class="text-sm py-12 text-gray-500 text-center">
  Hoohack's Blog since 2014
</footer>
  </div>

</div>



</body>
</html>