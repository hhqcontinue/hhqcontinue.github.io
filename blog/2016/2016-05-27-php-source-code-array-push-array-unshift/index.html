<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta property="og:title" content="[PHP源码阅读]array_push和array_unshift函数" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://hoohack.me/blog/2016/2016-05-27-php-source-code-array-push-array-unshift/" />
  <link rel="stylesheet" href="/styles/main.css">
  <link rel="me" href="https://mas.to/@djyde">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.27.0/themes/prism.min.css">
  
  <title>[PHP源码阅读]array_push和array_unshift函数 | Hoohack&#39;s Blog</title>
  
  <script async src="https://ana.hoohack.me/ana.js" data-website-id="380499a9-5e2b-4320-bb7d-fc6bb57fdf79"></script>
</head>
<body>
  
<div>
  <div class="container mx-auto prose py-12 sm:py-24 px-12 sm:px-0">
    <div class="mb-12">
      <a class="no-underline font-bold" href="/">Hoohack&#39;s Blog</a>
    </div>
    <h1>[PHP源码阅读]array_push和array_unshift函数</h1>
    <div class="italic text-gray-500">
      2016/05/27
    </div>
    <div>
      <p>在PHP中，在数组中添加元素也是一种很常用的操作，分别有在数组尾部和头部添加元素，看看PHP内部是如何实现数组插入的操作。</p>
<p>我在github有对PHP源码更详细的注解。感兴趣的可以围观一下，给个star。<a href="https://github.com/read-php-src/read-php-src">PHP5.4源码注解</a>。可以通过<a href="https://github.com/read-php-src/read-php-src/commits/master">commit记录</a>查看已添加的注解。</p>
<h2 id="array_push" tabindex="-1">array_push</h2>
<p>int array_push ( array &amp;$array , mixed $value1 [ , mixed $... ] )</p>
<p>array_push函数将array参数看做一个栈，将传递进来的变量压倒array的尾部。array的长度随着被压进去的变量个数增加。下面的代码有意义的效果：</p>
<p>$array[] = $var;</p>
<p>如果只需要添加一个元素到数组，使用$array[] 这种方式更好，因为这样做不用调用函数。</p>
<h3 id="%E8%BF%90%E8%A1%8C%E7%A4%BA%E4%BE%8B" tabindex="-1">运行示例</h3>
<p>$arr = array();
array_push($arr, 1, 2, 3); // return 3; $arr = [1, 2, 3]</p>
<h3 id="%E8%BF%90%E8%A1%8C%E6%AD%A5%E9%AA%A4" tabindex="-1">运行步骤</h3>
<p>array_push函数相对比较简单，就相当于压栈操作，把array看做一个栈，然后对每一个参数，让其变成引用，引用数加一，然后添加它到数组的尾部。</p>
<p>内部实现的流程图如下：</p>
<p><img src="http://7u2eqw.com1.z0.glb.clouddn.com/array_push.png" alt="array_push流程图"></p>
<h3 id="%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB" tabindex="-1">源码解读</h3>
<p>添加元素使用了<strong>zend_hash_next_index_insert</strong>函数，此函数是_zend_hash_next_index_insert函数的宏定义，这个函数是PHP内部实现数组的数据结构--哈希表包含的一些API，这个API用于追加元素到哈希表或者更新哈希表中已有的哈希值。此函数实现的流程图如下：</p>
<p><img src="http://7u2eqw.com1.z0.glb.clouddn.com/zend_insert.png" alt="zend_insert"></p>
<h2 id="array_unshift" tabindex="-1">array_unshift</h2>
<p>int arrat_unshift ( array &amp;$array , mixed $value1 [ , mixed $... ] )</p>
<p>array_unshift函数将数据元素插入到数组的头部，插入时是作为整体插入，因此后面的参数将保持同样的顺序。插入后所有的数值键名将修改为从零开始计数，所有的文字键名不变。</p>
<h3 id="%E8%BF%90%E8%A1%8C%E7%A4%BA%E4%BE%8B-1" tabindex="-1">运行示例</h3>
<p>$arr = array(1, 2, 3);
array_unshift($arr, 4, 5, 6); // 4 5 6 1 2 3</p>
<h3 id="%E8%BF%90%E8%A1%8C%E6%AD%A5%E9%AA%A4-1" tabindex="-1">运行步骤</h3>
<blockquote>
<p>1、调用php_splice将数据元素插入到数组头部，用新的哈希表替换就得哈希表并将其销毁</p>
<p>2、如果操作后的stack等于运行时的符号表，则重置哈希表的内部指针</p>
<p>3、stack指向新的哈希表，释放新的哈希表红箭，销毁就得哈希表</p>
</blockquote>
<h3 id="%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-1" tabindex="-1">源码解读</h3>
<p>由上面的步骤可知，array_unshift的核心步骤是php_splice函数。对于array_unshift函数，php_splice实现时新建一个哈希表out_hash，将需要插入的list数据先插入到out_hash中，然后再把原来的数组数据写入到out_hash中，这样实现在数组前面插入数据元素的功能。</p>
<p>实现的效果图如下：</p>
<p><img src="http://7u2eqw.com1.z0.glb.clouddn.com/php_splice.png" alt="php_splice"></p>
<h2 id="%E5%B0%8F%E7%BB%93" tabindex="-1">小结</h2>
<p>要理解array_push函数的执行过程主要理解栈的思想即可，而array_unshift则是新建一个数组，然后将两数组合并为结果数组。
这次阅读源码过程中，同时也研究了PHP中的哈希表数据结构及一些API，也给自己补充了一些哈希表的知识。学习到了PHP底层是使用双向链表做哈希冲突的处理，获益匪浅。日后再做关于PHP数据结构的分享。</p>
<p>原创文章，文笔有限，才疏学浅，文中若有不正之处，万望告知。</p>
<p>如果本文对你有帮助，<strong>点收藏的同时也请点下推荐吧</strong>，谢谢^_^</p>
<p>我在github有对PHP源码更详细的注解。感兴趣的可以围观一下，给个star。<a href="https://github.com/read-php-src/read-php-src">PHP5.4源码注解</a>。可以通过<a href="https://github.com/read-php-src/read-php-src/commits/master">commit记录</a>查看已添加的注解。</p>
<p>更多源码文章，欢迎访问个人主页继续查看：<a href="https://www.hoohack.me">hoohack</a></p>

    </div>
    <hr />
      <div class="text-sm text-center">
        <div id="tcomment"></div>
<script src="https://cdn.staticfile.org/twikoo/1.6.16/twikoo.all.min.js"></script>
<script>
twikoo.init({
  envId: 'https://discus.hoohack.me', // 腾讯云环境填 envId；Vercel 环境填地址（https://xxx.vercel.app）
  el: '#tcomment', // 容器元素
  // region: 'ap-guangzhou', // 环境地域，默认为 ap-shanghai，腾讯云环境填 ap-shanghai 或 ap-guangzhou；Vercel 环境不填
  // path: location.pathname, // 用于区分不同文章的自定义 js 路径，如果您的文章路径不是 location.pathname，需传此参数
  // lang: 'zh-CN', // 用于手动设定评论区语言，支持的语言列表 https://github.com/imaegoo/twikoo/blob/main/src/client/utils/i18n/index.js
})
</script>
      </div>
      <hr />
    <div class="text-center">
<img class="w-64 inline-block" src="https://www.hoohack.me/assets/images/reward.jpeg" alt="" />
<div class="text-sm">
通过赞赏码赞助此文
</div>
</div>
    <footer class="text-sm py-12 text-gray-500 text-center">
  Hoohack's Blog since 2014
</footer>
  </div>

</div>



</body>
</html>